---
phase: 02-core-parsing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/clean/cleanText.ts
  - src/clean/cleaners.ts
  - src/clean/index.ts
  - tests/clean/cleanText.test.ts
autonomous: true

must_haves:
  truths:
    - "Developer can clean text with HTML stripping, whitespace normalization, OCR artifact removal"
    - "Cleaned text includes transformation map for position tracking"
    - "Custom cleaning functions can be composed via pipeline"
  artifacts:
    - path: "src/clean/cleanText.ts"
      provides: "cleanText() function with TransformationMap building"
      min_lines: 80
      exports: ["cleanText"]
    - path: "src/clean/cleaners.ts"
      provides: "Built-in cleaner functions"
      exports: ["stripHtmlTags", "normalizeWhitespace", "normalizeUnicode", "fixSmartQuotes", "removeOcrArtifacts"]
    - path: "tests/clean/cleanText.test.ts"
      provides: "Position tracking validation"
      min_lines: 50
  key_links:
    - from: "src/clean/cleanText.ts"
      to: "src/types/span.ts"
      via: "TransformationMap import"
      pattern: "import.*TransformationMap.*from.*span"
    - from: "src/clean/cleanText.ts"
      to: "src/clean/cleaners.ts"
      via: "Default cleaners import"
      pattern: "import.*from.*cleaners"
---

<objective>
Implement text cleaning layer with position tracking via TransformationMap. This layer preprocesses legal text (HTML stripping, whitespace normalization, OCR artifact removal) while maintaining accurate position mappings for Phase 1's dual-span architecture.

Purpose: Enables accurate citation extraction from real-world legal documents (HTML-heavy court opinions, OCR'd PDFs)
Output: cleanText() function, built-in cleaners, position tracking tests
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-parsing/02-CONTEXT.md
@.planning/phases/02-core-parsing/02-RESEARCH.md
@src/types/span.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create built-in cleaner functions</name>
  <files>src/clean/cleaners.ts, src/clean/index.ts</files>
  <action>
Create `src/clean/cleaners.ts` with five built-in cleaner functions:

1. `stripHtmlTags(text: string): string` - Remove all HTML tags via regex `/<[^>]+>/g`
2. `normalizeWhitespace(text: string): string` - Convert tabs/newlines to spaces, collapse multiple spaces
3. `normalizeUnicode(text: string): string` - Apply NFKC normalization (ligatures â†’ separate chars)
4. `fixSmartQuotes(text: string): string` - Replace curly quotes/apostrophes with straight quotes
5. `removeOcrArtifacts(text: string): string` - Remove underscores from OCR text

Each cleaner is a simple function: `(text: string) => string`. Add JSDoc comments explaining purpose.

Create `src/clean/index.ts` with re-exports: `export * from "./cleaners"` and `export * from "./cleanText"` (created in Task 2).

IMPORTANT: Use simple, readable implementations. Avoid complex regex that could introduce ReDoS. Reference RESEARCH.md code examples for cleaner patterns.
  </action>
  <verify>
Run `npm run typecheck` - no errors
Check that each cleaner is exported from src/clean/index.ts
  </verify>
  <done>Five built-in cleaners exist and compile without errors, exported from src/clean/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Implement cleanText() with TransformationMap building</name>
  <files>src/clean/cleanText.ts</files>
  <action>
Create `src/clean/cleanText.ts` implementing:

```typescript
export interface CleanTextResult {
  cleaned: string
  transformationMap: TransformationMap
  warnings: Warning[]
}

export interface Warning {
  level: 'error' | 'warning' | 'info'
  message: string
  position: { start: number; end: number }
}

export function cleanText(
  original: string,
  cleaners: Array<(text: string) => string> = [
    stripHtmlTags,
    normalizeWhitespace,
    normalizeUnicode,
    fixSmartQuotes,
  ]
): CleanTextResult
```

Implementation approach (from RESEARCH.md):
1. Initialize 1:1 position mapping: `cleanToOriginal[i] = i` and `originalToClean[i] = i`
2. Apply each cleaner sequentially
3. After each cleaner, rebuild position maps by comparing before/after strings
4. Use character-by-character diff to track removals/expansions
5. Return cleaned text, TransformationMap (as Map objects), and empty warnings array

**Simplified position tracking:** For MVP, use conservative approach: when text length changes, rebuild map linearly by finding character matches. This handles simple cases (HTML removal, whitespace collapse). Complex Unicode transformations may not be 100% accurate initially - that's acceptable for Phase 2.

Import TransformationMap from src/types/span. Import cleaners from src/clean/cleaners.

Add JSDoc explaining dual position tracking purpose.
  </action>
  <verify>
Run `npm run typecheck` - no errors
Check that cleanText returns CleanTextResult with all three fields
Verify TransformationMap is imported from src/types/span
  </verify>
  <done>cleanText() function exists, builds TransformationMap, returns cleaned text with warnings</done>
</task>

<task type="auto">
  <name>Task 3: Test position tracking accuracy</name>
  <files>tests/clean/cleanText.test.ts</files>
  <action>
Create `tests/clean/cleanText.test.ts` with Vitest tests validating:

**Test 1: Identity transformation (no changes)**
- Input: "Smith v. Doe, 500 F.2d 123"
- After cleaning (no cleaners applied): positions unchanged
- Assert: `cleanToOriginal.get(14) === 14`

**Test 2: HTML tag removal**
- Input: "Smith v. <b>Doe</b>, 500 F.2d 123"
- After stripHtmlTags: "Smith v. Doe, 500 F.2d 123"
- Assert: Position 14 in cleaned maps to correct position in original (accounting for removed `<b>` tag)

**Test 3: Whitespace normalization**
- Input: "Smith  v.  Doe,   500 F.2d 123" (multiple spaces)
- After normalizeWhitespace: "Smith v. Doe, 500 F.2d 123"
- Assert: Positions track correctly after space collapse

**Test 4: Combined cleaners**
- Input: "<p>Smith v. Doe, 500 F.2d 123</p>" (HTML + spaces)
- After all cleaners: "Smith v. Doe, 500 F.2d 123"
- Assert: Pick a citation position (e.g., "500 F.2d 123" starts at position N), verify `original.substring(originalPos) === "500 F.2d 123"`

**Test 5: Custom cleaner**
- Pass custom cleaner function, verify it's applied
- Assert: Cleaned text reflects custom transformation

Use descriptive test names: `it('should track positions after HTML tag removal', ...)`.

Run tests with `npm test tests/clean/cleanText.test.ts`.
  </action>
  <verify>
Run `npm test tests/clean/cleanText.test.ts` - all tests pass
Test coverage for src/clean/cleanText.ts >= 80% (Vitest coverage report)
  </verify>
  <done>Position tracking tests pass, validating TransformationMap accuracy for common text transformations</done>
</task>

</tasks>

<verification>
1. Run `npm run typecheck` - no TypeScript errors
2. Run `npm test tests/clean/` - all cleaning tests pass
3. Check that cleanText() is exported from src/clean/index.ts
4. Verify TransformationMap is correctly imported from src/types/span
5. Test coverage >= 80% for src/clean/ directory
</verification>

<success_criteria>
- Developer can call cleanText(input) and receive cleaned text with position map
- Built-in cleaners handle HTML, whitespace, Unicode, smart quotes, OCR artifacts
- Custom cleaners can be passed via array parameter
- Position tracking is validated for common transformations
- All code compiles with TypeScript strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-parsing/02-01-SUMMARY.md`
</output>
