---
phase: 02-core-parsing
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/types/citation.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Citation type system includes all Phase 2 citation types (case, statute, journal, neutral, public law, federal register)"
    - "Each citation type has metadata fields matching Python eyecite"
    - "Discriminated unions enable type-safe pattern matching"
  artifacts:
    - path: "src/types/citation.ts"
      provides: "Extended citation types"
      contains: "JournalCitation"
      contains: "NeutralCitation"
      contains: "PublicLawCitation"
      contains: "FederalRegisterCitation"
  key_links:
    - from: "src/types/citation.ts"
      to: "src/types/span.ts"
      via: "Span import for CitationBase"
      pattern: "import.*Span.*from.*span"
---

<objective>
Extend Phase 1 citation type system with journal, neutral, public law, and federal register citation types. Each type includes metadata fields from CONTEXT.md decisions and RESEARCH.md specifications, matching Python eyecite field structure.

Purpose: Completes type system for extraction layer (Plan 5)
Output: Extended citation types with metadata fields
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-parsing/02-CONTEXT.md
@.planning/phases/02-core-parsing/02-RESEARCH.md
@src/types/citation.ts
@src/types/span.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend CitationBase with confidence and metadata fields</name>
  <files>src/types/citation.ts</files>
  <action>
Update `src/types/citation.ts` to add fields to CitationBase (from CONTEXT.md decisions):

```typescript
export interface CitationBase {
  text: string
  span: Span

  // NEW: confidence scoring
  confidence: number // 0-1, where 1.0 = certain match

  // NEW: matched text (exact substring)
  matchedText: string

  // NEW: processing metadata
  processTimeMs: number
  patternsChecked: number

  // NEW: warnings for malformed regions
  warnings?: Warning[]
}

export interface Warning {
  level: 'error' | 'warning' | 'info'
  message: string
  position: { start: number; end: number }
  context?: string
}
```

These fields are required by CONTEXT.md decisions: "Always include confidence score", "Include matchedText field", "Include processing stats".

Update existing citation types (FullCaseCitation, StatuteCitation, IdCitation) to inherit from updated CitationBase - no code changes needed, they automatically get new fields.

Add JSDoc comments explaining confidence scoring and processing stats.
  </action>
  <verify>
Run `npm run typecheck` - no errors
Check that CitationBase has confidence, matchedText, processTimeMs, patternsChecked fields
Verify existing citation types compile without changes
  </verify>
  <done>CitationBase extended with confidence, metadata, and warning fields</done>
</task>

<task type="auto">
  <name>Task 2: Add journal, neutral, public law, and federal register citation types</name>
  <files>src/types/citation.ts</files>
  <action>
Add four new citation types to `src/types/citation.ts` (from RESEARCH.md Pattern 4):

```typescript
export interface JournalCitation extends CitationBase {
  type: 'journal'
  author?: string
  title?: string
  volume?: number
  journal: string
  abbreviation: string
  page?: number
  pincite?: number
  year?: number
}

export interface NeutralCitation extends CitationBase {
  type: 'neutral'
  year: number
  court: string
  documentNumber: string
  // e.g., "2020 WL 123456" or "2020 U.S. LEXIS 456"
}

export interface PublicLawCitation extends CitationBase {
  type: 'publicLaw'
  congress: number
  lawNumber: number
  // e.g., "Pub. L. No. 116-283"
  title?: string // Optional: extracted from nearby text
}

export interface FederalRegisterCitation extends CitationBase {
  type: 'federalRegister'
  volume: number
  page: number
  year?: number
  // e.g., "85 Fed. Reg. 12345"
}
```

Update CitationType union:
```typescript
export type CitationType =
  | "case"
  | "statute"
  | "journal"
  | "neutral"
  | "publicLaw"
  | "federalRegister"
  | "id"
```

Update Citation union type:
```typescript
export type Citation =
  | FullCaseCitation
  | StatuteCitation
  | JournalCitation
  | NeutralCitation
  | PublicLawCitation
  | FederalRegisterCitation
  | IdCitation
```

Add JSDoc comments for each new type explaining format and examples.

**Metadata field rationale:**
- Journal: Matches Python eyecite journal citation fields
- Neutral: Year + court + document number is standard neutral citation format
- Public law: Congress + law number is standard format (Pub. L. No. {congress}-{lawNumber})
- Federal Register: Volume + page matches standard Fed. Reg. format

All new types inherit confidence, matchedText, processTimeMs, warnings from CitationBase.
  </action>
  <verify>
Run `npm run typecheck` - no errors
Check that all new types are in Citation union
Verify CitationType includes all new discriminators
Test type-safe pattern matching with switch statement (add example in comment)
  </verify>
  <done>Four new citation types added (journal, neutral, public law, federal register) with metadata fields</done>
</task>

<task type="auto">
  <name>Task 3: Add optional metadata fields to FullCaseCitation</name>
  <files>src/types/citation.ts</files>
  <action>
Extend FullCaseCitation with additional metadata fields from CONTEXT.md decisions:

```typescript
export interface FullCaseCitation extends CitationBase {
  type: "case"
  volume: number
  reporter: string
  page: number
  pincite?: number
  court?: string
  year?: number

  // NEW: normalized reporter form
  normalizedReporter?: string

  // NEW: parallel citations
  parallelCitations?: Array<{ volume: number; reporter: string; page: number }>

  // NEW: citation signal (See, Cf., But see)
  signal?: 'see' | 'see also' | 'cf' | 'but see' | 'compare'

  // NEW: parenthetical explanation
  parenthetical?: string

  // NEW: subsequent history
  subsequentHistory?: string // "aff'd", "rev'd", "cert. denied"

  // NEW: date structure
  date?: {
    iso: string // ISO 8601 format
    parsed?: { year: number; month?: number; day?: number }
  }

  // NEW: ambiguous interpretations
  possibleInterpretations?: Array<{
    volume: number
    reporter: string
    page: number
    confidence: number
    reason: string
  }>
}
```

These fields satisfy CONTEXT.md requirements: "Include both original reporter text and normalized form", "Extract citation signals", "Extract parenthetical explanations", "Extract subsequent history", "Include both ISO string and structured object for dates", "Return all possible interpretations for ambiguous citations".

All fields are optional (extraction layer may not find them all). Add JSDoc explaining purpose.
  </action>
  <verify>
Run `npm run typecheck` - no errors
Check that FullCaseCitation compiles with new optional fields
Verify existing code using FullCaseCitation still compiles (optional fields don't break existing usage)
  </verify>
  <done>FullCaseCitation extended with normalized reporter, parallel citations, signals, parentheticals, subsequent history, dates, and ambiguous interpretations</done>
</task>

</tasks>

<verification>
1. Run `npm run typecheck` - no TypeScript errors
2. Check that all citation types export from src/types/index.ts
3. Verify CitationType union includes all 7 types
4. Test that type guards work: `if (citation.type === 'journal') { citation.journal }` compiles
5. Confirm existing Phase 1 code still compiles with extended types
</verification>

<success_criteria>
- Citation type system includes all Phase 2 types (case, statute, journal, neutral, public law, federal register, id)
- Each type has metadata fields matching Python eyecite structure
- CitationBase includes confidence, matchedText, processTimeMs, warnings
- Discriminated unions enable type-safe pattern matching in extraction layer
- All code compiles with TypeScript strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-parsing/02-04-SUMMARY.md`
</output>
