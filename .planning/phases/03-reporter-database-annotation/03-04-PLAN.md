---
phase: 03-reporter-database-annotation
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - package.json
  - tsdown.config.ts
  - scripts/check-bundle-size.ts
  - tests/integration/phase3.test.ts
  - vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "Core bundle is <50KB gzipped verified by CI/CD check"
    - "Reporter data shipped as separate lazy-loadable chunk"
    - "Library processes 10KB legal document in <100ms"
    - "Integration tests validate Phase 3 complete (validation + annotation)"
  artifacts:
    - path: "scripts/check-bundle-size.ts"
      provides: "Bundle size validation script for CI/CD"
      min_lines: 40
    - path: "tests/integration/phase3.test.ts"
      provides: "End-to-end Phase 3 integration tests"
      min_lines: 80
    - path: "package.json"
      provides: "Updated exports for data layer"
      contains: '"./data"'
  key_links:
    - from: "scripts/check-bundle-size.ts"
      to: "dist/index.mjs and dist/data/index.mjs"
      via: "File size measurement with gzip"
      pattern: "gzipSize|dist/index\\.mjs"
    - from: "tests/integration/phase3.test.ts"
      to: "Full pipeline: clean → extract → validate → annotate"
      via: "Integration test"
      pattern: "cleanText.*extract.*validate.*annotate"
---

<objective>
Optimize bundle size with separate data chunks, validate performance constraints (<50KB core, <100ms for 10KB docs), and verify Phase 3 complete via integration tests.

Purpose: Ensures bundle size and performance requirements met before Phase 4
Output: Bundle size CI/CD check, separate data chunk, integration tests, performance validation
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-reporter-database-annotation/03-CONTEXT.md
@.planning/phases/03-reporter-database-annotation/03-RESEARCH.md
@.planning/phases/03-reporter-database-annotation/03-01-SUMMARY.md
@.planning/phases/03-reporter-database-annotation/03-02-SUMMARY.md
@.planning/phases/03-reporter-database-annotation/03-03-SUMMARY.md
@package.json
@tsdown.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure separate data chunk and verify exports</name>
  <files>package.json, tsdown.config.ts</files>
  <action>
Update `package.json` exports to include data layer (if not already added in 03-01):

```json
{
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.mjs",
      "require": "./dist/index.cjs"
    },
    "./data": {
      "types": "./dist/data/index.d.ts",
      "import": "./dist/data/index.mjs",
      "require": "./dist/data/index.cjs"
    },
    "./annotate": {
      "types": "./dist/annotate/index.d.ts",
      "import": "./dist/annotate/index.mjs",
      "require": "./dist/annotate/index.cjs"
    }
  }
}
```

Verify `tsdown.config.ts` outputs separate entry points for `src/data/index.ts` and `src/annotate/index.ts`.

Add script to package.json:
```json
"scripts": {
  "check:size": "node scripts/check-bundle-size.ts"
}
```

IMPORTANT: Data layer must NOT be imported by core index.ts (prevents bundle bloat). Verify with `grep -r "from.*data" src/index.ts` returns empty.
  </action>
  <verify>
Run `npm run build` - no errors
Check that dist/index.mjs, dist/data/index.mjs, dist/annotate/index.mjs exist
Verify src/index.ts does NOT import from src/data
  </verify>
  <done>Separate entry points configured, data chunk isolated from core bundle</done>
</task>

<task type="auto">
  <name>Task 2: Create bundle size validation script</name>
  <files>scripts/check-bundle-size.ts</files>
  <action>
Create `scripts/check-bundle-size.ts` with bundle size checks:

```typescript
import { statSync } from 'node:fs'
import { gzipSync } from 'node:zlib'
import { readFileSync } from 'node:fs'

interface BundleCheck {
  file: string
  maxSizeKb: number
}

const checks: BundleCheck[] = [
  { file: 'dist/index.mjs', maxSizeKb: 50 },         // Core bundle <50KB
  { file: 'dist/data/index.mjs', maxSizeKb: 100 },   // Data chunk can be larger
  { file: 'dist/annotate/index.mjs', maxSizeKb: 20 }, // Annotation layer small
]

let failed = false

for (const { file, maxSizeKb } of checks) {
  try {
    const content = readFileSync(file, 'utf-8')
    const gzipped = gzipSync(content)
    const sizeKb = gzipped.length / 1024

    const status = sizeKb <= maxSizeKb ? '✓' : '✗'
    console.log(`${status} ${file}: ${sizeKb.toFixed(1)} KB (max: ${maxSizeKb} KB)`)

    if (sizeKb > maxSizeKb) {
      failed = true
    }
  } catch (err) {
    console.error(`✗ ${file}: File not found`)
    failed = true
  }
}

if (failed) {
  console.error('\nBundle size check FAILED')
  process.exit(1)
} else {
  console.log('\nBundle size check PASSED')
}
```

This script validates PERF-01 requirement (<50KB core bundle gzipped).

IMPORTANT: Use Node.js built-in zlib (no dependencies). Fail build if size exceeds limits.
  </action>
  <verify>
Run `npm run check:size` - PASSED
Check that script fails if bundle exceeds 50KB (test by temporarily lowering threshold)
Verify gzip compression is used (not raw file size)
  </verify>
  <done>Bundle size validation script working, CI/CD ready</done>
</task>

<task type="auto">
  <name>Task 3: Integration tests and performance validation</name>
  <files>tests/integration/phase3.test.ts, vitest.config.ts</files>
  <action>
Create `tests/integration/phase3.test.ts` with end-to-end tests:

**Test 1: Full pipeline - clean → extract → validate → annotate**
- Input: Real legal text (10KB sample with HTML, multiple citations)
- Clean text with cleanText()
- Extract citations with extract()
- Load reporter database with loadReporters()
- Validate with extractWithValidation()
- Annotate with annotate()
- Assert: All steps complete without errors
- Check: Annotated text contains markup

**Test 2: Performance - 10KB document in <100ms (PERF-02)**
- Input: 10KB legal document
- Measure total time for extract() + validate()
- Assert: Total time < 100ms
- Use Vitest's performance timing

**Test 3: Degraded mode works without reporter database**
- Extract citations without calling loadReporters()
- Validate with extractWithValidation({ validate: true })
- Assert: Citations returned with info warning
- Check: No errors thrown

**Test 4: Annotation preserves HTML entities**
- Input: Text with HTML: "See <em>500 F.2d 123</em>"
- Annotate with template mode, autoEscape: true
- Assert: Output contains escaped HTML (&lt;em&gt;)

**Test 5: Confidence scoring adjusts based on reporter match**
- Extract citation with known reporter
- Validate against database
- Assert: Confidence boosted (+0.2)
- Extract citation with unknown reporter
- Validate
- Assert: Confidence penalized (-0.3)

Update `vitest.config.ts` to include integration tests folder if needed.

Use Vitest's `describe`, `it`, `expect`. Measure performance with `performance.now()`.
  </action>
  <verify>
Run `npm test tests/integration/phase3.test.ts` - all tests pass
Check that performance test completes in <100ms
Verify degraded mode test passes without database
  </verify>
  <done>Integration tests pass, performance validated, Phase 3 complete</done>
</task>

</tasks>

<verification>
- [ ] Run `npm run build` - no errors
- [ ] Run `npm run check:size` - PASSED (<50KB core bundle)
- [ ] Run `npm test tests/integration/phase3.test.ts` - all tests pass
- [ ] Check that dist/index.mjs and dist/data/index.mjs are separate files
- [ ] Verify performance test: 10KB document processes in <100ms
</verification>

<success_criteria>
Plan succeeds when:
1. Core bundle is <50KB gzipped verified by CI/CD script
2. Reporter data shipped as separate lazy-loadable chunk
3. Library processes 10KB legal document in <100ms
4. Integration tests validate full Phase 3 pipeline
5. Bundle size script integrated into CI/CD workflow
</success_criteria>

<output>
After completion, create `.planning/phases/03-reporter-database-annotation/03-04-SUMMARY.md`
</output>
